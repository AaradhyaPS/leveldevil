const config = {
  type: Phaser.AUTO,
  width: 900,
  height: 480,
  physics: { default: 'arcade', arcade: { gravity: { y: 1000 }, debug: false }},
  scene: { preload, create, update }
};
const game = new Phaser.Game(config);
let player, cursors, groundLayer, camera;

function preload(){
  this.load.image('bg','assets/bg.png');
  this.load.image('ground','assets/ground.png');
  this.load.image('car','assets/car.png');
  this.load.image('coin','assets/coin.png');
}

function create(){
  this.add.tileSprite(450,240,900,480,'bg').setScrollFactor(0);
  // create long ground by tiling sprites
  groundLayer = this.add.group();
  for(let i=0;i<200;i++){
    let x = i*160;
    let g = this.physics.add.staticImage(x, 360 + (Math.random()-0.5)*140, 'ground');
    g.setOrigin(0.5,0.5);
    groundLayer.add(g);
  }

  player = this.physics.add.sprite(150, 200, 'car').setScale(0.6);
  player.setCollideWorldBounds(false);
  player.setDrag(100);
  player.setBounce(0.1);

  // simple collision with ground by overlap check via Arcade's world bounds
  this.physics.add.collider(player, groundLayer, () => {}, null, this);

  cursors = this.input.keyboard.createCursorKeys();

  // coins
  const coins = this.physics.add.group();
  for(let i=3;i<150;i+=3){
    let x = i*160 + 80;
    let y = 220 + (Math.random()-0.5)*120;
    let c = coins.create(x,y,'coin');
    c.setImmovable(true);
  }
  this.physics.add.overlap(player, coins, (p,c)=>{
    c.destroy();
  }, null, this);

  camera = this.cameras.main;
  camera.startFollow(player, true, 0.08, 0.08);
  camera.setBounds(0,0,160*200,480);
  this.cameras.main.setZoom(1);
}

function update(){
  if (cursors.right.isDown) { player.setAccelerationX(600); }
  else if (cursors.left.isDown) { player.setAccelerationX(-300); }
  else { player.setAccelerationX(0); player.setDragX(700); }

  if (cursors.up.isDown && player.body.onFloor()) { player.setVelocityY(-420); }
}
